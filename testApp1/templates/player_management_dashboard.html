{% extends "base.html" %}

{% block title %}Advanced Player Management Dashboard{% endblock %}

{% block extra_css %}
<!-- D3.js for advanced visualizations -->
<script src="https://d3js.org/d3.v7.min.js"></script>
<!-- Chart.js and plugins -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Modern styles -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/player-management-modern.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/player-comparison.css') }}">
{% endblock %}

{% block content %}
<div class="player-dashboard-container">
    <!-- Sticky Header with Stats -->
    <div class="sticky-header">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h1 class="mb-0" style="color: white; font-size: 1.75rem; font-weight: 700;">
                        <i class="fas fa-tachometer-alt me-2" style="color: var(--accent-red);"></i>
                        Player Management
                    </h1>
                    <p class="text-secondary mb-0" style="font-size: 0.9rem;">Advanced Analytics & Comparison</p>
                </div>
                <div class="col-md-6 text-end">
                    <button class="neon-button neon-button-secondary me-2" onclick="refreshDashboard()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <button class="neon-button neon-button-primary" onclick="playerComparison.openPanel()">
                        <i class="fas fa-chart-line"></i> Compare Players
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid mt-4">
        <!-- Quick Stats Row -->
        <div class="row mb-4 stagger-animation">
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="neon-stat-card">
                    <i class="fas fa-users stat-icon"></i>
                    <div class="stat-value" id="total-players">-</div>
                    <div class="stat-label">Total Players</div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="neon-stat-card">
                    <i class="fas fa-chart-line stat-icon"></i>
                    <div class="stat-value" id="total-scorecards">-</div>
                    <div class="stat-label">Total Scorecards</div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="neon-stat-card">
                    <i class="fas fa-clock stat-icon"></i>
                    <div class="stat-value" id="recent-players">-</div>
                    <div class="stat-label">Recent (30d)</div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="neon-stat-card">
                    <i class="fas fa-fire stat-icon"></i>
                    <div class="stat-value" id="active-players">-</div>
                    <div class="stat-label">Active (7d)</div>
                </div>
            </div>
        </div>

        <!-- Filter Bar -->
        <div class="filter-bar fade-in-up">
            <input type="text" 
                   id="player-search-modern" 
                   class="search-input-modern" 
                   placeholder="🔍 Search players..."
                   autocomplete="off">
            
            <select id="sort-filter-modern" class="filter-select">
                <option value="name">Sort by Name</option>
                <option value="date">Sort by Date</option>
                <option value="scorecards">Sort by Scorecards</option>
                <option value="last_activity">Sort by Activity</option>
            </select>
            
            <button id="sort-order-toggle" class="neon-button neon-button-secondary" title="Toggle sort order">
                <i class="fas fa-sort-amount-up"></i>
            </button>
            
            <button id="clear-filters-btn" class="neon-button neon-button-secondary" title="Clear all filters">
                <i class="fas fa-times"></i> Clear
            </button>
        </div>

        <!-- Quick Filter Chips -->
        <div class="filter-chips mb-4 fade-in-up">
            <div class="filter-chip" data-filter="active_7d">
                <i class="fas fa-fire me-1"></i> Active Last 7 Days
            </div>
            <div class="filter-chip" data-filter="high_performers">
                <i class="fas fa-star me-1"></i> High Performers
            </div>
            <div class="filter-chip" data-filter="new_players">
                <i class="fas fa-plus-circle me-1"></i> New Players
            </div>
            <div class="filter-chip" data-filter="no_scorecards">
                <i class="fas fa-exclamation-triangle me-1"></i> No Scorecards
            </div>
        </div>

        <!-- Filter Stats -->
        <div id="filter-stats" class="text-center mb-3" style="display: none; color: var(--text-secondary); font-size: 0.9rem;"></div>

        <!-- Players Grid -->
        <div id="players-grid-container" class="player-grid">
            <!-- Loading skeleton -->
            <div class="skeleton skeleton-card"></div>
            <div class="skeleton skeleton-card"></div>
            <div class="skeleton skeleton-card"></div>
        </div>

        <!-- Charts Section -->
        <div class="row mt-5">
            <div class="col-lg-6 mb-4">
                <div class="chart-container-modern fade-in-up">
                    <div class="chart-header">
                        <div class="chart-title">
                            <i class="fas fa-chart-line me-2" style="color: var(--accent-red);"></i>
                            Player Activity Over Time
                        </div>
                    </div>
                    <div class="chart-canvas">
                        <canvas id="playerActivityChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-6 mb-4">
                <div class="chart-container-modern fade-in-up">
                    <div class="chart-header">
                        <div class="chart-title">
                            <i class="fas fa-chart-pie me-2" style="color: var(--accent-red);"></i>
                            Scorecard Distribution
                        </div>
                    </div>
                    <div class="chart-canvas">
                        <canvas id="scorecardDistributionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- SQL Metrics Section -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="chart-container-modern fade-in-up">
                    <div class="chart-header">
                        <div class="chart-title">
                            <i class="fas fa-database me-2" style="color: var(--accent-red);"></i>
                            Database Insights
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-4 mb-3">
                            <div class="chart-canvas">
                                <canvas id="attributeHeatmap"></canvas>
                            </div>
                        </div>
                        <div class="col-lg-4 mb-3">
                            <div class="chart-canvas">
                                <canvas id="tableUsageChart"></canvas>
                            </div>
                        </div>
                        <div class="col-lg-4 mb-3">
                            <div class="chart-canvas">
                                <canvas id="dataCompletenessChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Comparison Panel (Fixed Sidebar) -->
<div id="comparison-panel" class="comparison-panel">
    <div id="comparison-panel-header" class="comparison-panel-header">
        <div class="comparison-panel-title">
            <i class="fas fa-chart-bar"></i>
            Player Comparison
        </div>
        <button id="close-comparison-btn" class="close-comparison-btn">
            ×
        </button>
    </div>
    <div id="comparison-panel-content" class="comparison-panel-content">
        <!-- Content will be dynamically rendered -->
    </div>
</div>

<!-- Comparison Toggle Button -->
<div id="comparison-toggle-btn" class="comparison-toggle-btn">
    <i class="fas fa-chart-bar"></i>
    <div id="comparison-badge" class="comparison-badge" style="display: none;">0</div>
</div>

{% endblock %}

{% block extra_js %}
<!-- Load visualization libraries -->
<script src="{{ url_for('static', filename='js/player-management-filters.js') }}"></script>
<script src="{{ url_for('static', filename='js/player-management-viz.js') }}"></script>
<script src="{{ url_for('static', filename='js/player-comparison.js') }}"></script>
<script src="{{ url_for('static', filename='js/sql-visualizations.js') }}"></script>

<script>
// Global variables
let currentPlayers = [];
let playerActivityChart = null;
let scorecardDistributionChart = null;

// Initialize dashboard on DOM ready
document.addEventListener('DOMContentLoaded', function() {
    console.log('Initializing Advanced Player Management Dashboard...');
    
    // Initialize systems
    window.filterSystem = initializeFilterSystem();
    playerComparison.init();
    
    // Load data
    loadDashboardStats();
    loadPlayers();
    initializeCharts();
    
    // Initialize SQL visualizations
    if (typeof window.sqlViz !== 'undefined') {
        window.sqlViz.init();
    }
    
    console.log('Dashboard initialized successfully');
});

// Load dashboard statistics
async function loadDashboardStats() {
    try {
        const response = await fetch('/api/dashboard/stats');
        const data = await response.json();
        
        if (data.success && data.player_statistics) {
            updateStatsCards(data.player_statistics);
            updateCharts(data);
        }
    } catch (error) {
        console.error('Error loading dashboard stats:', error);
    }
}

// Update statistics cards
function updateStatsCards(stats) {
    document.getElementById('total-players').textContent = stats.total_players || 0;
    document.getElementById('total-scorecards').textContent = stats.total_scorecards || 0;
    document.getElementById('recent-players').textContent = stats.recent_players || 0;
    document.getElementById('active-players').textContent = stats.recent_scorecards || 0;
}

// Load players data
async function loadPlayers() {
    try {
        const response = await fetch('/api/players/advanced');
        const data = await response.json();
        
        if (data.success) {
            currentPlayers = data.players;
            
            // Load into filter system
            if (window.filterSystem) {
                window.filterSystem.loadPlayers(data.players);
            } else {
                displayPlayers(data.players);
            }
        }
    } catch (error) {
        console.error('Error loading players:', error);
        displayPlayers([]);
    }
}

// Display players in grid
function displayPlayers(players) {
    const container = document.getElementById('players-grid-container');
    
    if (!players || players.length === 0) {
        container.innerHTML = `
            <div class="col-12 text-center py-5" style="grid-column: 1 / -1;">
                <i class="fas fa-users fa-3x mb-3" style="color: rgba(249, 66, 58, 0.3);"></i>
                <h4 style="color: var(--text-primary);">No Players Found</h4>
                <p style="color: var(--text-secondary);">Try adjusting your filters or create a new player</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = players.map(player => `
        <div class="player-card-modern" data-player-name="${player.name}">
            <div class="player-name">${player.name}</div>
            <div class="player-meta">
                <i class="fas fa-calendar me-1"></i> 
                ${new Date(player.date_created * 1000).toLocaleDateString()}
            </div>
            <div class="player-stats-inline">
                <div class="stat-badge">
                    <i class="fas fa-chart-line me-1"></i>
                    ${player.scorecard_count || 0} scorecards
                </div>
            </div>
            <div class="action-buttons mt-3">
                <button class="action-btn compare-btn" title="Add to comparison" onclick="playerComparison.addPlayerToComparison('${player.name}')">
                    <i class="fas fa-chart-bar"></i>
                </button>
                <button class="action-btn" title="View details" onclick="viewPlayerDetails('${player.name}')">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="action-btn" title="Add scorecard" onclick="addScorecard('${player.name}')">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        </div>
    `).join('');
}

// Initialize charts
function initializeCharts() {
    // Player Activity Chart
    const playerCtx = document.getElementById('playerActivityChart');
    if (playerCtx) {
        playerActivityChart = new Chart(playerCtx.getContext('2d'), {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Players Created',
                    data: [],
                    borderColor: '#F9423A',
                    backgroundColor: 'rgba(249, 66, 58, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: { color: 'white', font: { size: 14, weight: '600' } }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.9)',
                        titleColor: '#F9423A',
                        bodyColor: 'white',
                        borderColor: '#F9423A',
                        borderWidth: 2
                    }
                },
                scales: {
                    x: {
                        ticks: { color: 'rgba(255, 255, 255, 0.7)' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    },
                    y: {
                        ticks: { color: 'rgba(255, 255, 255, 0.7)' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    }
                }
            }
        });
    }

    // Scorecard Distribution Chart
    const scorecardCtx = document.getElementById('scorecardDistributionChart');
    if (scorecardCtx) {
        scorecardDistributionChart = new Chart(scorecardCtx.getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: ['With Scorecards', 'Without Scorecards'],
                datasets: [{
                    data: [0, 0],
                    backgroundColor: ['rgba(249, 66, 58, 0.8)', 'rgba(96, 165, 250, 0.8)'],
                    borderColor: 'rgba(0, 0, 0, 0.8)',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { color: 'white', padding: 15, font: { size: 13, weight: '600' } }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.9)',
                        titleColor: '#F9423A',
                        bodyColor: 'white',
                        borderColor: '#F9423A',
                        borderWidth: 2
                    }
                }
            }
        });
    }
}

// Update charts with data
function updateCharts(data) {
    if (data.scorecard_analytics && data.scorecard_analytics.daily_scorecards && playerActivityChart) {
        const chartData = data.scorecard_analytics.daily_scorecards;
        playerActivityChart.data.labels = chartData.map(item => item.date);
        playerActivityChart.data.datasets[0].data = chartData.map(item => item.count);
        playerActivityChart.update();
    }

    if (data.player_statistics && scorecardDistributionChart) {
        const stats = data.player_statistics;
        scorecardDistributionChart.data.datasets[0].data = [
            stats.players_with_scorecards || 0,
            stats.players_without_scorecards || 0
        ];
        scorecardDistributionChart.update();
    }
}

// Utility functions
function refreshDashboard() {
    loadDashboardStats();
    loadPlayers();
    if (typeof window.sqlViz !== 'undefined') {
        window.sqlViz.refresh();
    }
    showToast('Dashboard refreshed', 'success');
}

function viewPlayerDetails(playerName) {
    window.location.href = `/player-data-overview`;
}

function addScorecard(playerName) {
    showToast(`Add scorecard for ${playerName}`, 'info');
}

function showToast(message, type = 'info') {
    // Simple toast implementation
    console.log(`[${type.toUpperCase()}] ${message}`);
}

// Export for use by other scripts
window.displayPlayers = displayPlayers;
window.currentPlayers = currentPlayers;
window.showToast = showToast;
</script>
{% endblock %}
